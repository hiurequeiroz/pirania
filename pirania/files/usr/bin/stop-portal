#!/bin/sh
# requires ip6tables-mod-nat and ipset

for ipvX in ipv4 ipv6 ; do
	if [ "$ipvX" = "ipv4" ] ; then
		iptables=iptables
		family=inet
		icmp=icmp
		ipaddr=ipaddr
	else
		iptables=ip6tables
		family=inet6
		icmp=icmpv6
		ipaddr=ip6addr
	fi

	### Cleanup
	for interface in br-lan anygw; do
		$iptables -t mangle -D PREROUTING -i $interface -j pirania
	done

	$iptables -t nat -D PREROUTING -j pirania
	$iptables -t filter -D FORWARD -j pirania

	for table in mangle nat filter; do
		$iptables -t $table -F pirania
		$iptables -t $table -X pirania
	done

	ipset destroy pirania-whitelist-$ipvX
done