#!/bin/sh
# requires ip6tables-mod-nat and ipset

for ipvX in ipv4 ipv6 ; do
	if [ "$ipvX" = "ipv4" ] ; then
		iptables=iptables
		family=inet
		icmp=icmp
	else
		iptables=ip6tables
		family=inet6
		icmp=icmpv6
	fi

	### Cleanup
	for interface in br-lan anygw bmx+; do
		$iptables -t mangle -D PREROUTING -i $interface -j pitbull
	done

	$iptables -t nat -D PREROUTING -j pitbull
	$iptables -t filter -D FORWARD -j pitbull

	for table in mangle nat filter; do
		$iptables -t $table -F pitbull
		$iptables -t $table -X pitbull
	done

	### Buildup
	for table in mangle nat filter; do
		$iptables -t $table -N pitbull
	done

	$iptables -t nat -A PREROUTING -j pitbull
	$iptables -t filter -A FORWARD -j pitbull

	for interface in br-lan anygw bmx+; do
		$iptables -t mangle -A PREROUTING -i $interface -j pitbull
	done

	ipset -exist create pitbull-auth-macs hash:mac timeout 0
	ipset -exist create pitbull-whitelist-$ipvX hash:net family $family
	$iptables -t mangle -A pitbull -p $icmp -j RETURN
	$iptables -t mangle -A pitbull -m set --match-set pitbull-auth-macs src -j RETURN
	$iptables -t mangle -A pitbull -m set --match-set pitbull-whitelist-$ipvX  dst -j RETURN
	$iptables -t mangle -A pitbull -j MARK --set-mark 0x66/0xff  # everything not icmp nor auth nor whitelisted will be marked for REJECT
	$iptables -t mangle -A pitbull -p tcp --dport 80 -j MARK --set-mark 0x80/0xff  # unless is dport 80, re-set mark for REDIRECT

	$iptables -t nat    -A pitbull -p tcp -m mark --mark 0x80/0xff -j REDIRECT --to-ports 2055
	$iptables -t filter -A pitbull -m mark --mark 0x66/0xff -j REJECT
done
